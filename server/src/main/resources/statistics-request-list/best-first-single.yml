queries:
  - headers:
      - First single
      - Person
    keyColumnIndex: 0
    showPositions: true
    positionTieBreakerIndex: 0
    sqlQuery: |-
      with rank_results as (
          select
              e.name event_name,
              e.id event_id,
              personId person_id,
              r.personName person_name,
              value1,
              dense_rank() over (
                  partition by personId,
                  eventId
                  order by
                      c.start_date,
                      rt.`rank`
              ) competition_order,
              e.`rank`
          from
              Results r
              inner join Competitions c on r.competitionId = c.id
              inner join RoundTypes rt on r.roundTypeId = rt.id
              inner join Events e on r.eventId = e.id
          where
              r.value1 > 0
              and e.`rank` < 900 -- Active events
      ),
      first_results as (
          select
              event_name,
              event_id,
              person_id,
              person_name,
              value1,
              rank() over (
                  partition by event_name
                  order by
                      value1
              ) event_rank
          from
              rank_results
          where
              competition_order = 1
          order by
              `rank`,
              value1
      )
      select
          event_name,
          case
              when event_id = '333fm' then value1
              when event_id = '333mbf' then replace(
                  replace(
                      replace(
                          concat(
                              99 - substring(value1, 1, 2) + substring(value1, 8, 2),
                              '/',
                              99 - substring(value1, 1, 2) + 2*substring(value1, 8, 2),
                              ' (',
                              sec_to_time(substring(value1, 3, 5)),
                              ')'
                          ),
                          '.000000',
                          ''
                      ),
                      '0000',
                      ''
                  ),
                  '00:',
                  ''
              )
              else substring(
                  replace(
                      replace(
                          replace(
                              replace(
                                  replace(sec_to_time(value1 / 100), '00:00:00.', '0.'),
                                  '00:00:0',
                                  ''
                              ),
                              '00:00:',
                              ''
                          ),
                          '00:0',
                          ''
                      ),
                      '00:',
                      ''
                  ),
                  1,
                  length(
                      replace(
                          replace(
                              replace(
                                  replace(
                                      replace(sec_to_time(value1 / 100), '00:00:00.', '0.'),
                                      '00:00:0',
                                      ''
                                  ),
                                  '00:00:',
                                  ''
                              ),
                              '00:0',
                              ''
                          ),
                          '00:',
                          ''
                      )
                  ) -2
              )
          end value1,
          concat(
              '<a href="https://www.worldcubeassociation.org/persons/',
              person_id,
              '">',
              person_name,
              '</a>'
          )
      from
          first_results
      where
          event_rank <= 20
title: Best first single
groupName: Competitors
displayMode: SELECTOR
